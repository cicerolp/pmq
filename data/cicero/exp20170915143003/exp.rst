=================
Benchmark Queries
=================


.. contents::

1 Description
-------------

Test the queries on uniform data. 
And compare the following performances.

- PMQ / GEOHASH

- BTREE

- RTREE - quadratic algorithm

- RTREE - quadratic algorithm with bulk loading

Use the refinement level = 8 

Elements:

- Timewindow = 26000

- Batch size = 1000

- Total elements = 26.000.000

2 Analysis
----------

2.1 Results
~~~~~~~~~~~

2.1.1 Plot overview
^^^^^^^^^^^^^^^^^^^

.. image:: ./img/overview_query_region.png

2.1.2 Conclusions
^^^^^^^^^^^^^^^^^

- PMQ shows its best benefits on large range queries.

- For small queries we are similar to othe Btree an Rtree.

- Bulk loading on Rtree only work on static case. The partitionning is optimized when all the queries are loaded together.


**NOTE** that in this synthetic dataset, the size of the query (in degrees) is proportional to the amount of elements returned because elements are uniformly distributed on the space. 
In a scenario of a Twitter distribution for instance, small queries will possibly result in very large amount of elements. 
We should expect a very different performance behavior in that cases.

2.2 What is the actual count of elements per query ?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

2.2.1 Table
^^^^^^^^^^^

Variance shows that some counts differ between algorithms:

.. table::

    +---------+--------------+----------------------+------------------+--------------+-------+
    | queryId | BTree\_Count | GeoHashBinary\_Count | RTreeBulk\_Count | RTree\_Count |   Var |
    +=========+==============+======================+==================+==============+=======+
    |       0 |      3440580 |              3440580 |          3440580 |      3440580 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |       1 |      3440446 |              3440446 |          3440447 |      3440447 | 0.333 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |       2 |      3438884 |              3438884 |          3438884 |      3438884 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |       3 |      3440915 |              3440915 |          3440916 |      3440916 | 0.333 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |       4 |      3442356 |              3442356 |          3442356 |      3442356 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |       5 |      3439224 |              3439224 |          3439224 |      3439224 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |       6 |      3438953 |              3438953 |          3438953 |      3438953 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |       7 |      3442233 |              3442233 |          3442234 |      3442234 | 0.333 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |       8 |      3441859 |              3441859 |          3441859 |      3441859 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |       9 |      3443858 |              3443858 |          3443858 |      3443858 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      10 |       859819 |               859819 |           859819 |       859819 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      11 |       860304 |               860304 |           860304 |       860304 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      12 |       862004 |               862004 |           862004 |       862004 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      13 |       859895 |               859895 |           859895 |       859895 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      14 |       862262 |               862262 |           862263 |       862263 | 0.333 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      15 |       859189 |               859189 |           859189 |       859189 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      16 |       859264 |               859264 |           859266 |       859266 | 1.333 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      17 |       861935 |               861935 |           861935 |       861935 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      18 |       861341 |               861341 |           861341 |       861341 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      19 |       859799 |               859799 |           859799 |       859799 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      20 |       214775 |               214775 |           214776 |       214776 | 0.333 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      21 |       214220 |               214220 |           214220 |       214220 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      22 |       215543 |               215543 |           215543 |       215543 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      23 |       214932 |               214932 |           214932 |       214932 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      24 |       215726 |               215726 |           215726 |       215726 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      25 |       214526 |               214526 |           214526 |       214526 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      26 |       215502 |               215502 |           215502 |       215502 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      27 |       214199 |               214199 |           214199 |       214199 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      28 |       215471 |               215471 |           215471 |       215471 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      29 |       214738 |               214738 |           214738 |       214738 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      30 |        53488 |                53488 |            53488 |        53488 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      31 |        54129 |                54129 |            54129 |        54129 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      32 |        53212 |                53212 |            53212 |        53212 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      33 |        53584 |                53584 |            53584 |        53584 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      34 |        53724 |                53724 |            53724 |        53724 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      35 |        53825 |                53825 |            53825 |        53825 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      36 |        53856 |                53856 |            53856 |        53856 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      37 |        53236 |                53236 |            53236 |        53236 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      38 |        53837 |                53837 |            53837 |        53837 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      39 |        53767 |                53767 |            53767 |        53767 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      40 |        13230 |                13230 |            13230 |        13230 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      41 |        13399 |                13399 |            13400 |        13400 | 0.333 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      42 |        13513 |                13513 |            13514 |        13514 | 0.333 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      43 |        13251 |                13251 |            13251 |        13251 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      44 |        13524 |                13524 |            13524 |        13524 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      45 |        13356 |                13356 |            13356 |        13356 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      46 |        13401 |                13401 |            13401 |        13401 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      47 |        13530 |                13530 |            13530 |        13530 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      48 |        13417 |                13417 |            13417 |        13417 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      49 |        13298 |                13298 |            13298 |        13298 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      50 |         3358 |                 3358 |             3358 |         3358 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      51 |         3304 |                 3304 |             3304 |         3304 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      52 |         3517 |                 3517 |             3517 |         3517 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      53 |         3338 |                 3338 |             3338 |         3338 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      54 |         3394 |                 3394 |             3394 |         3394 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      55 |         3353 |                 3353 |             3353 |         3353 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      56 |         3356 |                 3356 |             3357 |         3357 | 0.333 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      57 |         3440 |                 3440 |             3440 |         3440 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      58 |         3455 |                 3455 |             3455 |         3455 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      59 |         3461 |                 3461 |             3461 |         3461 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      60 |          842 |                  842 |              842 |          842 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      61 |          808 |                  808 |              808 |          808 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      62 |          840 |                  840 |              840 |          840 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      63 |          834 |                  834 |              834 |          834 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      64 |          839 |                  839 |              839 |          839 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      65 |          852 |                  852 |              852 |          852 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      66 |          797 |                  797 |              797 |          797 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      67 |          843 |                  843 |              843 |          843 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      68 |          813 |                  813 |              813 |          813 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      69 |          895 |                  895 |              895 |          895 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      70 |          225 |                  225 |              225 |          225 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      71 |          184 |                  184 |              184 |          184 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      72 |          209 |                  209 |              209 |          209 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      73 |          199 |                  199 |              199 |          199 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      74 |          212 |                  212 |              212 |          212 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      75 |          222 |                  222 |              222 |          222 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      76 |          213 |                  213 |              213 |          213 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      77 |          192 |                  192 |              192 |          192 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      78 |          196 |                  196 |              196 |          196 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      79 |          188 |                  188 |              188 |          188 |     0 |
    +---------+--------------+----------------------+------------------+--------------+-------+



Just the diverging queries : 

.. table:: Queries that returned different result depending on the algorithm

    +---------+--------------+----------------------+------------------+--------------+-------+
    | queryId | BTree\_Count | GeoHashBinary\_Count | RTreeBulk\_Count | RTree\_Count |   Var |
    +=========+==============+======================+==================+==============+=======+
    |       1 |      3440446 |              3440446 |          3440447 |      3440447 | 0.333 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |       3 |      3440915 |              3440915 |          3440916 |      3440916 | 0.333 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |       7 |      3442233 |              3442233 |          3442234 |      3442234 | 0.333 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      14 |       862262 |               862262 |           862263 |       862263 | 0.333 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      16 |       859264 |               859264 |           859266 |       859266 | 1.333 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      20 |       214775 |               214775 |           214776 |       214776 | 0.333 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      41 |        13399 |                13399 |            13400 |        13400 | 0.333 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      42 |        13513 |                13513 |            13514 |        13514 | 0.333 |
    +---------+--------------+----------------------+------------------+--------------+-------+
    |      56 |         3356 |                 3356 |             3357 |         3357 | 0.333 |
    +---------+--------------+----------------------+------------------+--------------+-------+

2.2.2 Plot
^^^^^^^^^^

There are some queries where the count differs for Rtree by a small amount of elements.

Counts have some differences :
These are the queries that for some misterious reason resulted in different counts.

.. image:: ./img/differing_counts.png
